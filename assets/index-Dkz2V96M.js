"stream"in Blob.prototype||Object.defineProperty(Blob.prototype,"stream",{value(){return new Response(this).body}}),"setBigUint64"in DataView.prototype||Object.defineProperty(DataView.prototype,"setBigUint64",{value(t,n,e){const i=Number(0xffffffffn&n),r=Number(n>>32n);this.setUint32(t+(e?0:4),i,e),this.setUint32(t+(e?4:0),r,e)}});var y=t=>new DataView(new ArrayBuffer(t)),u=t=>new Uint8Array(t.buffer||t),U=t=>new TextEncoder().encode(String(t)),c=t=>Math.min(4294967295,Number(t)),B=t=>Math.min(65535,Number(t));function A(t,n){if(t instanceof File)return{isFile:1,t:new Date(t.lastModified),i:t.stream()};if(t instanceof Response)return{isFile:1,t:new Date(t.headers.get("Last-Modified")||Date.now()),i:t.body};if(n=new Date,t===void 0)return{isFile:0,t:n};if(typeof t=="string")return{isFile:1,t:n,i:U(t)};if(t instanceof Blob)return{isFile:1,t:n,i:t.stream()};if(t instanceof Uint8Array||t instanceof ReadableStream)return{isFile:1,t:n,i:t};if(t instanceof ArrayBuffer||ArrayBuffer.isView(t))return{isFile:1,t:n,i:u(t)};if(Symbol.asyncIterator in t)return{isFile:1,t:n,i:v(t[Symbol.asyncIterator]())};throw new TypeError("Unsupported input format.")}function v(t,n=t){return new ReadableStream({async pull(e){let i=0;for(;e.desiredSize>i;){const r=await t.next();if(!r.value){e.close();break}{const s=D(r.value);e.enqueue(s),i+=s.byteLength}}},cancel(e){var i;(i=n.throw)==null||i.call(n,e)}})}function D(t){return typeof t=="string"?U(t):t instanceof Uint8Array?t:u(t)}function I(t,n,e){let[i,r]=function(s){return[void 0,0]}();if(t instanceof File)return{o:m(i||U(t.name)),u:BigInt(t.size),l:r};if(t instanceof Response){const s=t.headers.get("content-disposition"),f=s&&s.match(/;\s*filename\*?=["']?(.*?)["']?$/i),a=f&&f[1]||t.url&&new URL(t.url).pathname.split("/").findLast(Boolean),l=a&&decodeURIComponent(a),g=+t.headers.get("content-length");return{o:m(i||U(l)),u:BigInt(g),l:r}}return i=m(i,t!==void 0||e!==void 0),typeof t=="string"?{o:i,u:BigInt(U(t).length),l:r}:t instanceof Blob?{o:i,u:BigInt(t.size),l:r}:t instanceof ArrayBuffer||ArrayBuffer.isView(t)?{o:i,u:BigInt(t.byteLength),l:r}:{o:i,u:R(t),l:r}}function R(t,n){return t?void 0:0n}function m(t,n=1){if(!t||t.every(e=>e===47))throw new Error("The file must have a name.");if(n)for(;t[t.length-1]===47;)t=t.subarray(0,-1);else t[t.length-1]!==47&&(t=new Uint8Array([...t,47]));return t}var F=new Uint32Array(256);for(let t=0;t<256;++t){let n=t;for(let e=0;e<8;++e)n=n>>>1^(1&n&&3988292384);F[t]=n}function b(t,n=0){n^=-1;for(var e=0,i=t.length;e<i;e++)n=n>>>8^F[255&n^t[e]];return(-1^n)>>>0}function x(t,n,e=0){const i=t.getSeconds()>>1|t.getMinutes()<<5|t.getHours()<<11,r=t.getDate()|t.getMonth()+1<<5|t.getFullYear()-1980<<9;n.setUint16(e,i,1),n.setUint16(e+2,r,1)}function L({o:t,l:n},e){return 8*(!n||(e??function(i){try{M.decode(i)}catch{return 0}return 1}(t)))}var M=new TextDecoder("utf8",{fatal:1});function T(t,n=0){const e=y(30);return e.setUint32(0,1347093252),e.setUint32(4,754976768|n),x(t.t,e,10),e.setUint16(26,t.o.length,1),u(e)}async function*z(t){let{i:n}=t;if("then"in n&&(n=await n),n instanceof Uint8Array)yield n,t.m=b(n,0),t.u=BigInt(n.length);else{t.u=0n;const e=n.getReader();for(;;){const{value:i,done:r}=await e.read();if(r)break;t.m=b(i,t.m),t.u+=BigInt(i.length),yield i}}}function E(t,n){const e=y(16+(n?8:0));return e.setUint32(0,1347094280),e.setUint32(4,t.isFile?t.m:0,1),n?(e.setBigUint64(8,t.u,1),e.setBigUint64(16,t.u,1)):(e.setUint32(8,c(t.u),1),e.setUint32(12,c(t.u),1)),u(e)}function N(t,n,e=0,i=0){const r=y(46);return r.setUint32(0,1347092738),r.setUint32(4,755182848),r.setUint16(8,2048|e),x(t.t,r,12),r.setUint32(16,t.isFile?t.m:0,1),r.setUint32(20,c(t.u),1),r.setUint32(24,c(t.u),1),r.setUint16(28,t.o.length,1),r.setUint16(30,i,1),r.setUint16(40,t.isFile?33204:16893,1),r.setUint32(42,c(n),1),u(r)}function C(t,n,e){const i=y(e);return i.setUint16(0,1,1),i.setUint16(2,e-4,1),16&e&&(i.setBigUint64(4,t.u,1),i.setBigUint64(12,t.u,1)),i.setBigUint64(e-8,n,1),u(i)}function S(t){return t instanceof File||t instanceof Response?[[t],[t]]:[[t.input,t.name,t.size],[t.input,t.lastModified]]}var V=t=>function(n){let e=BigInt(22),i=0n,r=0;for(const s of n){if(!s.o)throw new Error("Every file must have a non-empty name.");if(s.u===void 0)throw new Error(`Missing size for file "${new TextDecoder().decode(s.o)}".`);const f=s.u>=0xffffffffn,a=i>=0xffffffffn;i+=BigInt(46+s.o.length+(f&&8))+s.u,e+=BigInt(s.o.length+46+(12*a|28*f)),r||(r=f)}return(r||i>=0xffffffffn)&&(e+=BigInt(76)),e+i}(function*(n){for(const e of n)yield I(...S(e)[0])}(t));function k(t,n={}){const e={"Content-Type":"application/zip","Content-Disposition":"attachment"};return(typeof n.length=="bigint"||Number.isInteger(n.length))&&n.length>0&&(e["Content-Length"]=String(n.length)),n.metadata&&(e["Content-Length"]=String(V(n.metadata))),new Response(j(t,n),{headers:e})}function j(t,n={}){const e=function(i){var s;const r=i[Symbol.iterator in i?Symbol.iterator:Symbol.asyncIterator]();return{async next(){const f=await r.next();if(f.done)return f;const[a,l]=S(f.value);return{done:0,value:Object.assign(A(...l),I(...a))}},throw:(s=r.throw)==null?void 0:s.bind(r),[Symbol.asyncIterator](){return this}}}(t);return v(async function*(i,r){const s=[];let f=0n,a=0n,l=0;for await(const o of i){const w=L(o,r.buffersAreUTF8);yield T(o,w),yield o.o,o.isFile&&(yield*z(o));const h=o.u>=0xffffffffn,p=12*(f>=0xffffffffn)|28*h;yield E(o,h),s.push(N(o,f,w,p)),s.push(o.o),p&&s.push(C(o,f,p)),h&&(f+=8n),a++,f+=BigInt(46+o.o.length)+o.u,l||(l=h)}let g=0n;for(const o of s)yield o,g+=BigInt(o.length);if(l||f>=0xffffffffn){const o=y(76);o.setUint32(0,1347094022),o.setBigUint64(4,BigInt(44),1),o.setUint32(12,755182848),o.setBigUint64(24,a,1),o.setBigUint64(32,a,1),o.setBigUint64(40,g,1),o.setBigUint64(48,f,1),o.setUint32(56,1347094023),o.setBigUint64(64,f+g,1),o.setUint32(72,1,1),yield u(o)}const d=y(22);d.setUint32(0,1347093766),d.setUint16(8,B(a),1),d.setUint16(10,B(a),1),d.setUint32(12,c(g),1),d.setUint32(16,c(f),1),yield u(d)}(e,n),e)}export{k as downloadZip,j as makeZip,V as predictLength};
